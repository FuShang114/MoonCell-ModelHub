<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoonCell Gateway 策略设置</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f7fb;
            color: #1f2937;
            line-height: 1.5;
        }

        .app { display: flex; min-height: 100vh; }

        .sidebar {
            width: 220px;
            background: #111827;
            color: #e5e7eb;
            padding: 20px 16px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 28px;
        }

        .brand-badge {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
        }

        .nav { display: flex; flex-direction: column; gap: 8px; }

        .nav a {
            color: #e5e7eb;
            text-decoration: none;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .nav a.active, .nav a:hover {
            background: rgba(59, 130, 246, 0.2);
            color: #fff;
        }

        .content { flex: 1; padding: 24px 28px 36px; }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .title-group h1 { font-size: 1.6rem; margin-bottom: 4px; }
        .title-group p { color: #6b7280; font-size: 0.9rem; }

        .btn {
            padding: 0.6rem 1.1rem;
            border: 1px solid transparent;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-primary { background: #2563eb; color: #fff; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-ghost { background: #fff; color: #1f2937; border: 1px solid #e5e7eb; }
        .btn-ghost:hover { border-color: #cbd5f5; color: #1d4ed8; }

        .panel {
            background: #fff;
            border-radius: 12px;
            padding: 18px;
            border: 1px solid #eef1f7;
        }

        .desc {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 14px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 12px;
            align-items: center;
        }

        .form-grid label {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .input-sm, .select-sm {
            width: 100%;
            padding: 0.55rem 0.7rem;
            border: 1px solid #dbe1f2;
            border-radius: 8px;
            font-size: 0.9rem;
            background: #fff;
        }

        .warn {
            margin-top: 14px;
            color: #92400e;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
        }

        .actions {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .error-message {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .success-message {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        @media (max-width: 900px) {
            .app { flex-direction: column; }
            .sidebar {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .nav { flex-direction: row; flex-wrap: wrap; }
        }

        @media (max-width: 780px) {
            .content { padding: 18px; }
            .topbar {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="app">
    <aside class="sidebar">
        <div class="brand">
            <span class="brand-badge">MC</span>
            MoonCell Gateway
        </div>
        <nav class="nav">
            <a href="/config">监控大盘</a>
            <a href="/admin/debug">调试台</a>
            <a class="active" href="/settings">策略设置</a>
        </nav>
    </aside>

    <main class="content">
        <div class="topbar">
            <div class="title-group">
                <h1>负载均衡策略设置</h1>
                <p>切换策略与参数，配置会实时生效，无需重启服务。</p>
            </div>
            <div style="display: flex; gap: 8px;">
                <a class="btn btn-ghost" href="/config">返回监控</a>
                <a class="btn btn-primary" href="/admin/debug">进入调试</a>
            </div>
        </div>

        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>

        <section class="panel">
            <div class="desc">负载均衡策略：随机采样 + 预算评分（60秒窗口 RPM/TPM 限制）。</div>

            <div class="form-grid">
                <label for="sampleCount">采样数量</label>
                <input id="sampleCount" class="input-sm" type="number" min="1" value="2">

                <label for="samplingRounds">采样轮次</label>
                <input id="samplingRounds" class="input-sm" type="number" min="1" value="2">

                <label for="queueCapacity">有界队列容量</label>
                <input id="queueCapacity" class="input-sm" type="number" min="1" value="128">
            </div>

            <div class="warn">提示：采样数量、采样轮次、有界队列容量生效。</div>

            <div class="actions">
                <button class="btn btn-primary" onclick="saveSettings()">保存并热切换</button>
            </div>
        </section>
    </main>
</div>

<script>
    async function loadSettings() {
        try {
            const resp = await fetch('/admin/load-balancing/settings');
            if (!resp.ok) throw new Error('加载失败');
            const data = await resp.json();
            document.getElementById('sampleCount').value = data.sampleCount || 2;
            document.getElementById('samplingRounds').value = data.samplingRounds || 2;
            document.getElementById('queueCapacity').value = data.queueCapacity || 128;
        } catch (error) {
            showError('加载策略设置失败: ' + error.message);
        }
    }

    async function saveSettings() {
        const payload = {
            algorithm: 'TRADITIONAL',
            sampleCount: Number(document.getElementById('sampleCount').value || 2),
            samplingRounds: Number(document.getElementById('samplingRounds').value || 2),
            queueCapacity: Number(document.getElementById('queueCapacity').value || 128)
        };
        try {
            const resp = await fetch('/admin/load-balancing/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) throw new Error('参数无效或保存失败');
            showSuccess('保存成功：已在线热切换到新策略，无需重启进程。');
        } catch (error) {
            showError('保存策略设置失败: ' + error.message);
        }
    }

    function showError(message) {
        const el = document.getElementById('error-message');
        el.textContent = message;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function showSuccess(message) {
        const el = document.getElementById('success-message');
        el.textContent = message;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    loadSettings();
</script>
</body>
</html>
